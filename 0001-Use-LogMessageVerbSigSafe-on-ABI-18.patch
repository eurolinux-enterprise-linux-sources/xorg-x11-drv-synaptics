From 0c3c3d64a91cc38e6bb95767e7ea5acf8d3fe1e1 Mon Sep 17 00:00:00 2001
From: Peter Hutterer <peter.hutterer@who-t.net>
Date: Fri, 25 May 2012 14:20:39 +1000
Subject: [PATCH synaptics] Use LogMessageVerbSigSafe on ABI 18

Signed-off-by: Peter Hutterer <peter.hutterer@who-t.net>
Reviewed-by: Chase Douglas <chase.douglas@canonical.com>
---
 src/eventcomm.c     | 8 ++++----
 src/ps2comm.c       | 8 ++++----
 src/synapticsstr.h  | 4 ++++
 test/fake-symbols.c | 6 ++++++
 4 files changed, 18 insertions(+), 8 deletions(-)

diff --git a/src/eventcomm.c b/src/eventcomm.c
index 280ef9b..b811da7 100644
--- a/src/eventcomm.c
+++ b/src/eventcomm.c
@@ -518,13 +518,13 @@ SynapticsReadEvent(InputInfoPtr pInfo, struct input_event *ev)
     if (len <= 0) {
         /* We use X_NONE here because it doesn't alloc */
         if (errno != EAGAIN)
-            xf86MsgVerb(X_NONE, 0, "%s: Read error %s\n", pInfo->name,
-                        strerror(errno));
+            LogMessageVerbSigSafe(X_ERROR, 0, "%s: Read error %d\n", pInfo->name,
+                                  errno);
         rc = FALSE;
     }
     else if (len % sizeof(*ev)) {
-        xf86MsgVerb(X_NONE, 0, "%s: Read error, invalid number of bytes.",
-                    pInfo->name);
+        LogMessageVerbSigSafe(X_ERROR, 0, "%s: Read error, invalid number of bytes.",
+                              pInfo->name);
         rc = FALSE;
     }
     return rc;
diff --git a/src/ps2comm.c b/src/ps2comm.c
index f88b5cb..bcbcf9b 100644
--- a/src/ps2comm.c
+++ b/src/ps2comm.c
@@ -483,8 +483,8 @@ ps2_synaptics_get_packet(InputInfoPtr pInfo, struct PS2SynapticsHwInfo *synhw,
 
         /* to avoid endless loops */
         if (count++ > 30) {
-            xf86IDrvMsg(pInfo, X_ERROR,
-                        "Synaptics driver lost sync... got gigantic packet!\n");
+            LogMessageVerbSigSafe(X_ERROR, 0,
+                                  "Synaptics driver lost sync... got gigantic packet!\n");
             return FALSE;
         }
 
@@ -538,8 +538,8 @@ PS2ReadHwStateProto(InputInfoPtr pInfo,
 
     synhw = (struct PS2SynapticsHwInfo *) priv->proto_data;
     if (!synhw) {
-        xf86IDrvMsg(pInfo, X_ERROR,
-                    "PS2ReadHwState, synhw is NULL. This is a bug.\n");
+        LogMessageVerbSigSafe(X_ERROR, 0,
+                              "PS2ReadHwState, synhw is NULL. This is a bug.\n");
         return FALSE;
     }
 
diff --git a/src/synapticsstr.h b/src/synapticsstr.h
index dd6a09b..fbae394 100644
--- a/src/synapticsstr.h
+++ b/src/synapticsstr.h
@@ -25,6 +25,10 @@
 #include "synproto.h"
 #include <xserver-properties.h>
 
+#if GET_ABI_MAJOR(ABI_XINPUT_VERSION) < 18
+#define LogMessageVerbSigSafe xf86MsgVerb
+#endif
+
 #ifdef DBG
 #undef DBG
 #endif
diff --git a/test/fake-symbols.c b/test/fake-symbols.c
index 6f55c7b..39d757a 100644
--- a/test/fake-symbols.c
+++ b/test/fake-symbols.c
@@ -327,6 +327,12 @@ xf86IDrvMsg(InputInfoPtr dev, MessageType type, const char *format, ...)
 }
 
 _X_EXPORT void
+LogMessageVerbSigSafe(MessageType type, int verb, const char *format, ...)
+{
+    return;
+}
+
+_X_EXPORT void
 xf86PostMotionEventP(DeviceIntPtr device,
                      int is_absolute, int first_valuator, int num_valuators,
 #if GET_ABI_MAJOR(ABI_XINPUT_VERSION) >= 12
-- 
1.7.11.2

